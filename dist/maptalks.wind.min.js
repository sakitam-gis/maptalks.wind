!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function i(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var a="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function rt(t,e,r){var n,a,i,o,s,c,u,p,l,h,d,f,_=r[0],v=r[1],m=r[2];return e===t?(t[12]=e[0]*_+e[4]*v+e[8]*m+e[12],t[13]=e[1]*_+e[5]*v+e[9]*m+e[13],t[14]=e[2]*_+e[6]*v+e[10]*m+e[14],t[15]=e[3]*_+e[7]*v+e[11]*m+e[15]):(n=e[0],a=e[1],i=e[2],o=e[3],s=e[4],c=e[5],u=e[6],p=e[7],l=e[8],h=e[9],d=e[10],f=e[11],t[0]=n,t[1]=a,t[2]=i,t[3]=o,t[4]=s,t[5]=c,t[6]=u,t[7]=p,t[8]=l,t[9]=h,t[10]=d,t[11]=f,t[12]=n*_+s*v+l*m+e[12],t[13]=a*_+c*v+h*m+e[13],t[14]=i*_+u*v+d*m+e[14],t[15]=o*_+p*v+f*m+e[15]),t}function nt(t,e,r){var n=r[0],a=r[1],i=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*a,t[5]=e[5]*a,t[6]=e[6]*a,t[7]=e[7]*a,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function r(){var t=new a(3);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function o(t,e,r){var n=new a(3);return n[0]=t,n[1]=e,n[2]=r,n}function s(t,e,r){var n=e[0],a=e[1],i=e[2],o=r[0],s=r[1],c=r[2];return t[0]=a*c-i*s,t[1]=i*o-n*c,t[2]=n*s-a*o,t}var c,u=function(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)};c=r();var p,l;p=new a(4),a!=Float32Array&&(p[0]=0,p[1]=0,p[2]=0,p[3]=0),l=p;function h(){var t=new a(4);return a!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function d(t,e,r,n){var a,i,o,s,c,u=e[0],p=e[1],l=e[2],h=e[3],d=r[0],f=r[1],_=r[2],v=r[3];return(i=u*d+p*f+l*_+h*v)<0&&(i=-i,d=-d,f=-f,_=-_,v=-v),c=1e-6<1-i?(a=Math.acos(i),o=Math.sin(a),s=Math.sin((1-n)*a)/o,Math.sin(n*a)/o):(s=1-n,n),t[0]=s*u+c*d,t[1]=s*p+c*f,t[2]=s*l+c*_,t[3]=s*h+c*v,t}var f,_,v,m,g,x,w,y=function(t,e){var r=e[0],n=e[1],a=e[2],i=e[3],o=r*r+n*n+a*a+i*i;return 0<o&&(o=1/Math.sqrt(o)),t[0]=r*o,t[1]=n*o,t[2]=a*o,t[3]=i*o,t};f=r(),_=o(1,0,0),v=o(0,1,0),m=h(),g=h(),x=new a(9),a!=Float32Array&&(x[1]=0,x[2]=0,x[3]=0,x[5]=0,x[6]=0,x[7]=0),x[0]=1,x[4]=1,x[8]=1,w=x;var T,R;T=new a(2),a!=Float32Array&&(T[0]=0,T[1]=0),R=T;function E(t,e,r){var n=t.createShader(e)||{};if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n)||"");return n}function b(t,e,r){var n=t.createProgram()||"",a=E(t,t.VERTEX_SHADER,e),i=E(t,t.FRAGMENT_SHADER,r);if(t.attachShader(n,a),t.attachShader(n,i),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(n)||"");for(var o={program:n},s=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES),c=0;c<s;c++){var u=t.getActiveAttrib(n,c);o[u.name]=t.getAttribLocation(n,u.name)}var p=t.getProgramParameter(n,t.ACTIVE_UNIFORMS);for(c=0;c<p;c++){var l=t.getActiveUniform(n,c);o[l.name]=t.getUniformLocation(n,l.name)}return o}function P(t,e,r,n,a){var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),r instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,a,0,t.RGBA,t.UNSIGNED_BYTE,r):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.bindTexture(t.TEXTURE_2D,null),i}function A(t,e,r){t.activeTexture(t.TEXTURE0+r),t.bindTexture(t.TEXTURE_2D,e)}function D(t,e){var r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),r}function M(t,e,r,n){t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,n,t.FLOAT,!1,0,0)}function S(t,e,r){t.bindFramebuffer(t.FRAMEBUFFER,e),r&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0)}var F={0:"#3288bd",.1:"#66c2a5",.2:"#abdda4",.3:"#e6f598",.4:"#fee08b",.5:"#fdae61",.6:"#f46d43",1:"#d53e4f"},C=function(){function et(t,e){var r=e.fadeOpacity,n=e.speedFactor,a=e.dropRate,i=e.dropRateBump,o=e.colorRamp,s=e.numParticles;this.options=e,this.gl=t,this.fadeOpacity=r||.895,this.speedFactor=n||.25,this.dropRate=a||.003,this.dropRateBump=i||.01,this.drawProgram=b(t,"precision mediump float;\n#define GLSLIFY 1\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nuniform mat4 u_matrix;\nuniform float u_dateline_offset;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n  vec4 color = texture2D(\n    u_particles,\n    vec2(\n      fract(a_index / u_particles_res),\n      floor(a_index / u_particles_res) / u_particles_res\n    )\n  );\n\n  v_particle_pos = vec2(\n    color.r / 255.0 + color.b,\n    color.g / 255.0 + color.a\n  );\n  gl_PointSize = 1.0;\n  gl_Position = u_matrix * vec4(v_particle_pos.xy + vec2(u_dateline_offset, 0), 0, 1);\n}\n","precision mediump float;\n#define GLSLIFY 1\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform sampler2D u_color_ramp;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n  vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, v_particle_pos).rg);\n  float speed_t = length(velocity) / length(u_wind_max);\n\n  // color ramp is encoded in a 16x16 texture\n  vec2 ramp_pos = vec2(\n  fract(16.0 * speed_t),\n  floor(16.0 * speed_t) / 16.0);\n\n  gl_FragColor = texture2D(u_color_ramp, ramp_pos);\n}\n"),this.screenProgram=b(t,"precision highp float;\n#define GLSLIFY 1\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n  v_tex_pos = a_pos;\n  gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n","precision highp float;\n#define GLSLIFY 1\n\nuniform sampler2D u_screen;\n\nuniform float u_opacity;\nuniform float u_opacity_border;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n  vec2 point = 1.0 - v_tex_pos;\n  vec4 color = texture2D(u_screen, point);\n\n  if (point.x < u_opacity_border || point.x > 1. - u_opacity_border || point.y < u_opacity_border || point.y > 1. - u_opacity_border) {\n    gl_FragColor = vec4(0.);\n  } else {\n    // opacity fade out even with a value close to 0.0\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n  }\n}\n"),this.updateProgram=b(t,"precision mediump float;\n#define GLSLIFY 1\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n  v_tex_pos = a_pos;\n  gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n","precision highp float;\n#define GLSLIFY 1\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\n//uniform vec4 u_bbox;\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\nfloat rand(const vec2 co) {\n  float t = dot(rand_constants.xy, co);\n  return fract(sin(t) * (rand_constants.z + t));\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n  // return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n  vec2 px = 1.0 / u_wind_res;\n  vec2 vc = (floor(uv * u_wind_res)) * px;\n  vec2 f = fract(uv * u_wind_res);\n  vec2 tl = texture2D(u_wind, vc).rg;\n  vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n  vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n  vec2 br = texture2D(u_wind, vc + px).rg;\n  return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n}\n\nvoid main() {\n  vec4 color = texture2D(u_particles, v_tex_pos);\n  vec2 pos = vec2(\n  color.r / 255.0 + color.b,\n  color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\n  // convert to global geographic position\n  //    vec2 global_pos = u_bbox.xy + pos * (u_bbox.zw - u_bbox.xy);\n\n  vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(pos));\n  float speed_t = length(velocity) / length(u_wind_max);\n\n  // take EPSG:4236 distortion into account for calculating where the particle moved\n  //    float distortion = cos(radians(global_pos.y * 180.0 - 90.0));\n  //    vec2 offset = vec2(velocity.x / distortion, -velocity.y) * 0.0001 * u_speed_factor;\n  vec2 offset = vec2(velocity.x, -velocity.y) * 0.0001 * u_speed_factor;\n  // update particle position, wrapping around the boundaries\n  pos = fract(1.0 + pos + offset);\n\n  // a random seed to use for the particle drop\n  vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\n  // drop rate is a chance a particle will restart at random position, to avoid degeneration\n  float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n  float drop = step(1.0 - drop_rate, rand(seed));\n\n  //    float retain = step(drop_rate, rand(seed));\n\n  vec2 random_pos = vec2(rand(seed + 1.3), rand(seed + 2.1));\n  //    pos = mix(pos, random_pos, 1.0 - retain);\n  pos = mix(pos, random_pos, drop);\n  // encode the new particle position back into RGBA\n  gl_FragColor = vec4(\n  fract(pos * 255.0),\n  floor(pos * 255.0) / 255.0);\n}\n"),this.quadBuffer=D(t,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])),this.framebuffer=t.createFramebuffer(),this.windData={},this.backgroundTexture=null,this.screenTexture=null,this.colorRampTexture=null,this.particleStateResolution=1/0,this._numParticles=1/0,this.particleIndexBuffer=null,this.particleStateTexture0=null,this.particleStateTexture1=null,this.windTexture=null,this.matrix=[],this.setColorRamp(o||F),this.numParticles=s||65536,this.resize()}return Object.defineProperty(et.prototype,"numParticles",{get:function(){return this._numParticles},set:function(t){var e=this.gl,r=Math.ceil(Math.sqrt(t));this.particleStateResolution=r,this._numParticles=r*r;for(var n=new Uint8Array(4*this._numParticles),a=0;a<n.length;a++)n[a]=Math.floor(256*Math.random());this.particleStateTexture0=P(e,e.NEAREST,n,r,r),this.particleStateTexture1=P(e,e.NEAREST,n,r,r);var i=new Float32Array(this._numParticles);for(a=0;a<this._numParticles;a++)i[a]=a;this.particleIndexBuffer=D(e,i)},enumerable:!0,configurable:!0}),et.prototype.setOptions=function(t){var e=t.fadeOpacity,r=t.speedFactor,n=t.dropRate,a=t.dropRateBump,i=t.colorRamp,o=t.numParticles;this.fadeOpacity=e||.996,this.speedFactor=r||.25,this.dropRate=n||.003,this.dropRateBump=a||.01,this.setColorRamp(i||F),this.numParticles=o||65536},et.prototype.resize=function(){var t=this.gl,e=new Uint8Array(t.canvas.width*t.canvas.height*4);this.backgroundTexture=P(t,t.NEAREST,e,t.canvas.width,t.canvas.height),this.screenTexture=P(t,t.NEAREST,e,t.canvas.width,t.canvas.height)},et.prototype.setColorRamp=function(t){this.colorRampTexture=P(this.gl,this.gl.LINEAR,function(e){var t=document.createElement("canvas"),r=t.getContext("2d");t.width=256,t.height=1;var n=r.createLinearGradient(0,0,256,0);return Object.keys(e).forEach(function(t){n.addColorStop(+t,e[t])}),r.fillStyle=n,r.fillRect(0,0,256,1),new Uint8Array(r.getImageData(0,0,256,1).data)}(t),16,16)},et.prototype.setWind=function(t,e){this.windData=t,this.windTexture=P(this.gl,this.gl.LINEAR,e)},et.prototype.render=function(t,e){var r=this.gl,n=this.windData;if(r&&n){this.matrix=t;var a=r.isEnabled(r.BLEND);r.disable(r.BLEND),r.disable(r.DEPTH_TEST),r.disable(r.STENCIL_TEST),A(r,this.windTexture,0),A(r,this.particleStateTexture0,1),this.drawScreen(t,e),this.updateParticles(),a&&r.enable(r.BLEND)}},et.prototype.drawScreen=function(t,e){var r=this.gl;S(r,this.framebuffer,this.screenTexture),r.viewport(0,0,r.canvas.width,r.canvas.height),this.drawTexture(this.backgroundTexture,this.fadeOpacity),this.drawParticles(t,e),S(r,null),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),this.drawTexture(this.screenTexture,1),r.disable(r.BLEND);var n=this.backgroundTexture;this.backgroundTexture=this.screenTexture,this.screenTexture=n},et.prototype.drawTexture=function(t,e){var r=this.gl,n=this.screenProgram;r.useProgram(n.program),M(r,this.quadBuffer,n.a_pos,2),A(r,t,2),r.uniform1i(n.u_screen,2),r.uniform1f(n.u_opacity_border,0),r.uniform1f(n.u_opacity,e),r.drawArrays(r.TRIANGLES,0,6)},et.prototype.drawParticles=function(t,e){var r=this.gl,n=this.drawProgram;r.useProgram(n.program),M(r,this.particleIndexBuffer,n.a_index,1),A(r,this.colorRampTexture,2),r.uniform1i(n.u_wind,0),r.uniform1i(n.u_particles,1),r.uniform1i(n.u_color_ramp,2),r.uniform1f(n.u_particles_res,this.particleStateResolution),r.uniform2f(n.u_wind_min,this.windData.uMin,this.windData.vMin),r.uniform2f(n.u_wind_max,this.windData.uMax,this.windData.vMax),r.uniform1f(n.u_dateline_offset,e),r.uniformMatrix4fv(n.u_matrix,!1,t),r.drawArrays(r.POINTS,0,this._numParticles)},et.prototype.updateParticles=function(){var t=this.gl;S(t,this.framebuffer,this.particleStateTexture1),t.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var e=this.updateProgram;t.useProgram(e.program),M(t,this.quadBuffer,e.a_pos,2),t.uniform1i(e.u_wind,0),t.uniform1i(e.u_particles,1),t.uniform1f(e.u_rand_seed,Math.random()),t.uniform2f(e.u_wind_res,this.windData.width,this.windData.height),t.uniform2f(e.u_wind_min,this.windData.uMin,this.windData.vMin),t.uniform2f(e.u_wind_max,this.windData.uMax,this.windData.vMax),t.uniform1f(e.u_speed_factor,this.speedFactor),t.uniform1f(e.u_drop_rate,this.dropRate),t.uniform1f(e.u_drop_rate_bump,this.dropRateBump),t.drawArrays(t.TRIANGLES,0,6);var r=this.particleStateTexture0;this.particleStateTexture0=this.particleStateTexture1,this.particleStateTexture1=r},et.wrap=function(t,e,r){var n=r-e,a=((t-e)%n+n)%n+e;return a===e?r:a},et.clamp=function(t,e,r){return Math.min(r,Math.max(e,t))},et.mercatorXfromLng=function(t){return(180+t)/360},et.mercatorYfromLat=function(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360},et.project=function(t,e){var r=et.clamp(t[1],-90,90);return[et.mercatorXfromLng(t[0])*e,et.mercatorYfromLat(r)*e]},et.calcMatrices=function(t,e,r,n,a,i){var o,s,c,u,p,l,h,d,f,_,v,m,g,x,w,y,T,R,E,b,P,A,D,M,S,F,C,I,L,B,O,U,N,k=r,G=a*Math.PI/180,X=i.width,z=i.height,j=et.clamp(k,0,85)/180*Math.PI,Y=-et.wrap(n,-180,180)*Math.PI/180,W=512*Math.pow(2,e-1),q=.5/Math.tan(G/2)*z,H=G/2,V=Math.PI/2+j,Z=Math.sin(H)*q/Math.sin(Math.PI-V-H),K=et.project(t,W),J=K[0],Q=K[1],$=1.01*(Math.cos(Math.PI/2-j)*Z+q),tt=new Float64Array(16);return o=tt,s=G,c=X/z,p=$,h=(u=1)/Math.tan(s/2),o[0]=h/c,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[11]=-1,o[12]=0,o[13]=0,o[15]=0,null!=p&&p!==1/0?(l=1/(u-p),o[10]=(p+u)*l,o[14]=2*p*u*l):(o[10]=-1,o[14]=-2*u),nt(tt,tt,[1,-1,1]),rt(tt,tt,[0,0,-q]),f=d=tt,_=j,v=Math.sin(_),m=Math.cos(_),g=f[4],x=f[5],w=f[6],y=f[7],T=f[8],R=f[9],E=f[10],b=f[11],f!==d&&(d[0]=f[0],d[1]=f[1],d[2]=f[2],d[3]=f[3],d[12]=f[12],d[13]=f[13],d[14]=f[14],d[15]=f[15]),d[4]=g*m+T*v,d[5]=x*m+R*v,d[6]=w*m+E*v,d[7]=y*m+b*v,d[8]=T*m-g*v,d[9]=R*m-x*v,d[10]=E*m-w*v,d[11]=b*m-y*v,A=P=tt,D=Y,M=Math.sin(D),S=Math.cos(D),F=A[0],C=A[1],I=A[2],L=A[3],B=A[4],O=A[5],U=A[6],N=A[7],A!==P&&(P[8]=A[8],P[9]=A[9],P[10]=A[10],P[11]=A[11],P[12]=A[12],P[13]=A[13],P[14]=A[14],P[15]=A[15]),P[0]=F*S+B*M,P[1]=C*S+O*M,P[2]=I*S+U*M,P[3]=L*S+N*M,P[4]=B*S-F*M,P[5]=O*S-C*M,P[6]=U*S-I*M,P[7]=N*S-L*M,rt(tt,tt,[-J,-Q,0]),nt([],tt,[W,W,W])},et}(),I=["webgl2","experimental-webgl","webgl","webkit-3d","moz-webgl"],L=function(t,e,r,n){if("undefined"==typeof document)return new n(t,e);var a=document.createElement("canvas");return a.width=t*r,a.height=e*r,a.style.width=t+"px",a.style.height=e+"px",a},B=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return i(t,r),t.prototype.checkResources=function(){return[]},t.prototype.getDrawParams=function(){return[]},t.prototype.hitDetect=function(){return!1},t.prototype.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer()},t.prototype.prepareDrawContext=function(){r.prototype.prepareDrawContext.call(this)},t.prototype._drawLayer=function(){var t=this._prepareDrawParams();t&&(this.layer.draw.apply(this.layer,t),this.completeRender())},t.prototype._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,this.gl,t],r=this.getDrawParams();return e.push.apply(e,r?Array.isArray(r)?r:[r]:[]),e.push.apply(e,this._drawContext),e},t.prototype.needToRedraw=function(){return!!this.layer.options.animation||r.prototype.needToRedraw.call(this)},t.prototype.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=this.canvas.getContext("2d"),this.context)){this.gl=function(t,e){if(void 0===e&&(e={}),!t)return null;for(var r=I.length,n=0;n<r;++n)try{var a=t.getContext(I[n],e);if(a)return a}catch(t){console.log(t)}return null}(this.canvas2,this.layer.options.glOptions);var t=this.getMap().getDevicePixelRatio();1!==t&&this.context.scale(t,t)}},t.prototype.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),r=t.getDevicePixelRatio(),n=[r*e.width,r*e.height],a=n[0],i=n[1];this.canvas=L(a,i,r,t.CanvasClass),this.canvas2=L(a,i,r,t.CanvasClass),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})}},t.prototype.checkForCanvasSizeChange=function(){var t=this.getMap().getSize(),e=t.width,r=t.height;return(e!==this._width||r!==this._height)&&(this._width=e,this._height=r,!0)},t.prototype.resizeCanvas=function(t){if(this.canvas&&this.gl){var e=this.getMap(),r=e.getDevicePixelRatio(),n=t||e.getSize();this.canvas.height=r*n.height,this.canvas.width=r*n.width,this.canvas2&&(this.canvas2.width=r*n.width,this.canvas2.height=r*n.height),this.gl&&this.canvas2&&this.layer.wind&&this.layer.wind.resize()}},t.prototype.clearCanvas=function(){this.canvas&&this.context&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.prepareCanvas=function(){this.canvas?(this.clearCanvas(),this.checkForCanvasSizeChange()&&this.resizeCanvas()):(this.createCanvas(),this.createContext())},t.prototype.renderScene=function(){this.completeRender()},t.prototype.drawOnInteracting=function(){this.draw()},t.prototype.onZoomStart=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];r.prototype.onZoomStart.apply(this,t)},t.prototype.onZoomEnd=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];r.prototype.onZoomEnd.apply(this,t)},t.prototype.remove=function(){delete this._drawContext,r.prototype.remove.call(this)},t.prototype.getMap=function(){return r.prototype.getMap.call(this)},t}(e.renderer.CanvasLayerRenderer),O={renderer:"webgl",doubleBuffer:!1,animation:!0,glOptions:{antialias:!1,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0}},U=function(a){function t(t,e,r){void 0===r&&(r={});var n=a.call(this,t,Object.assign(O,r))||this;return n.datas=e,n.wind=null,n}return i(t,a),t.prototype.setOptions=function(t){void 0===t&&(t={}),this.options=Object.assign(this.options,t),this.wind&&this.wind.setOptions(this.options)},t.prototype.getWindData=function(){return this.datas},t.prototype.setWindData=function(t){this.datas=t,this.wind&&this.wind.setWind(this.datas.data,this.datas.image)},t.prototype.prepareToDraw=function(){return[]},t.prototype.draw=function(t,e){var r=this.getMap();if(r){var n=r.getCenter(),a=r.getSize(),i=r.getZoom(),o=r.getPitch(),s=r.getBearing(),c=r.getFov(),u=r.getProjExtent(),p=u.getMin(),l=u.getMax(),h=r.getSpatialReference().getProjection().metersPerDegree||6378137*Math.PI/180,d=C.calcMatrices([n.x,n.y],i,o,s,c,a);if(!this.wind){if(!t)return;var f=this.options,_=f.fadeOpacity,v=f.speedFactor,m=f.dropRate,g=f.dropRateBump,x=f.colorRamp,w=f.numParticles;this.wind=new C(e,{fadeOpacity:_,speedFactor:v,dropRate:m,dropRateBump:g,colorRamp:x,numParticles:w})}if(this.wind){var y=r._getPrjCenter(),T=(p.x-y.x)/h,R=(l.x-y.x)/h,E=Math.max(0,Math.ceil((R-180)/360)),b=Math.max(0,Math.ceil((T+180)/-360));this.wind.render(d,0);for(var P=1;P<=E;P++)this.wind.render(d,P);for(var A=1;A<=b;A++)this.wind.render(d,-A)}t.drawImage(e.canvas,0,0),this.completeRender()}},t.prototype.drawOnInteracting=function(t,e){this.draw(t,e)},t.prototype.onResize=function(){a.prototype.onResize.call(this)},t.prototype.remove=function(){a.prototype.remove.call(this)},t}(e.CanvasLayer);U.registerRenderer("webgl",B),t.WindLayer=U,Object.defineProperty(t,"__esModule",{value:!0})});
